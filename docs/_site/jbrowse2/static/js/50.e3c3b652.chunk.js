(this["webpackJsonp@jbrowse/web"]=this["webpackJsonp@jbrowse/web"]||[]).push([[50],{2544:function(e,t,r){"use strict";r.r(t),r.d(t,"default",(function(){return y}));var a=r(87),n=r.n(a),i=r(91),s=r(86),c=r(90),o=r(93),u=r(95),d=r(2073),f=r(127),h=r(84),l=r(129),g=r(81),p=r(140),m=r(1078),v=r(101),_=r(88),b=function(){function e(t,r){Object(s.a)(this,e),this.record=void 0,this._store=void 0,this.record=t,this._store=r}return Object(c.a)(e,[{key:"_get_name",value:function(){return this.record.readName}},{key:"_get_start",value:function(){return this.record.alignmentStart-1}},{key:"_get_end",value:function(){return this.record.alignmentStart+this.record.lengthOnRef-1}},{key:"_get_cram_read_features",value:function(){return this.record.readFeatures}},{key:"_get_type",value:function(){return"match"}},{key:"_get_score",value:function(){return this.record.mappingQuality}},{key:"_get_flags",value:function(){return this.record.flags}},{key:"_get_strand",value:function(){return this.record.isReverseComplemented()?-1:1}},{key:"_read_group_id",value:function(){var e=this._store.samHeader.readGroups;return e?e[this.record.readGroupId]:void 0}},{key:"_get_qual",value:function(){return(this.record.qualityScores||[]).join(" ")}},{key:"qualRaw",value:function(){return this.record.qualityScores}},{key:"_get_seq_id",value:function(){return this._store.refIdToName(this.record.sequenceId)}},{key:"_get_refName",value:function(){return this._get_seq_id()}},{key:"_get_is_paired",value:function(){return!!this.record.mate}},{key:"_get_pair_orientation",value:function(){return this.record.isPaired()?this.record.getPairOrientation():void 0}},{key:"_get_template_length",value:function(){return this.record.templateLength||this.record.templateSize}},{key:"_get_next_seq_id",value:function(){return this.record.mate?this._store.refIdToName(this.record.mate.sequenceId):void 0}},{key:"_get_next_pos",value:function(){return this.record.mate?this.record.mate.alignmentStart:void 0}},{key:"_get_next_segment_position",value:function(){return this.record.mate?"".concat(this._store.refIdToName(this.record.mate.sequenceId),":").concat(this.record.mate.alignmentStart):void 0}},{key:"_get_tags",value:function(){var e=this._read_group_id(),t=this.record.tags;return void 0!==e?Object(_.a)(Object(_.a)({},t),{},{RG:e}):t}},{key:"_get_seq",value:function(){return this.record.getReadBases()}},{key:"_get_CIGAR",value:function(){var e="",t="",r="M",a=0,n=this.record._refRegion.seq,i=this.record._refRegion.start,s=this.record.alignmentStart,c=0;return"undefined"!==typeof this.record.readFeatures?this.record.readFeatures.forEach((function(o){var u=o.code,d=o.refPos,f=o.sub,h=o.data;if(c=d-s,e+=n.substring(s-i,d-i),s=d,a&&"M"!==r&&(t+=a+r,a=0),c&&(r="M",a+=c),"b"===u){var l=h.split(","),g=String.fromCharCode.apply(String,Object(v.a)(l));e+=g,s+=g.length,a+=g.length}else"B"===u||"X"===u?(e+=f,s++,a++):"D"===u||"N"===u?(s+=h,a&&(t+=a+r),t+=h+u,a=0):"I"===u||"S"===u?(e+=h,a&&(t+=a+r),t+=h.length+u,a=0):"i"===u?(e+=h,a&&(t+=a+r),t+="".concat(1,"I"),a=0):"P"===u?(a&&(t+=a+r),t+="".concat(h,"P")):"H"===u&&(a&&(t+=a+r),t+="".concat(h,"H"),a=0)})):c=this.record.readLength-e.length,e.length!==this.record.readLength&&(c=this.record.readLength-e.length,e+=n.substring(s-i,s-i+c),a&&"M"!==r&&(t+=a+r,a=0),r="M",a+=c),a&&(t+=a+r),t}},{key:"tags",value:function(){return Object.getOwnPropertyNames(e.prototype).filter((function(e){return e.startsWith("_get_")&&"_get_mismatches"!==e&&"_get_skips_and_dels"!==e&&"_get_cram_read_features"!==e})).map((function(e){return e.replace("_get_","")}))}},{key:"id",value:function(){return"".concat(this._store.id,"-").concat(this.record.uniqueId)}},{key:"get",value:function(e){var t="_get_".concat(e);if(this[t])return this[t]()}},{key:"parent",value:function(){}},{key:"children",value:function(){}},{key:"set",value:function(){}},{key:"pairedFeature",value:function(){return!1}},{key:"_get_clipPos",value:function(){var e=this.get("mismatches");if(e.length){var t=-1===this.get("strand")?e[e.length-1]:e[0],r=t.type,a=t.cliplen;if("softclip"===r||"hardclip"===r)return a}return 0}},{key:"toJSON",value:function(){var e=this,t={};return this.tags().forEach((function(r){var a=e.get(r);void 0!==a&&(t[r]=a)})),Object(_.a)(Object(_.a)({},t),{},{name:this.get("name"),type:this.get("type"),uniqueId:this.id()})}},{key:"_get_mismatches",value:function(){var e=this.get("cram_read_features"),t=this.qualRaw();if(!e)return[];var r=this.get("start"),a=[];return e.forEach((function(e){var n=e.code,i=e.pos,s=e.data,c=e.sub,o=e.ref,u=e.refPos-1-r;if("X"===n)a.push({start:u,length:1,base:c,qual:null===t||void 0===t?void 0:t[i],altbase:o,type:"mismatch"});else if("I"===n)a.push({start:u,type:"insertion",base:"".concat(s.length),length:0});else if("N"===n)a.push({type:"skip",length:s,start:u,base:"N"});else if("S"===n){var d=s.length;a.push({start:u,type:"softclip",base:"S".concat(d),cliplen:d,length:1})}else if("P"===n);else if("H"===n){var f=s;a.push({start:u,type:"hardclip",base:"H".concat(f),cliplen:f,length:1})}else"D"===n?a.push({type:"deletion",length:s,start:u,base:"*"}):"b"===n||"q"===n||"B"===n||"i"===n&&a.push({start:u,type:"insertion",base:s,length:1})})),a}},{key:"_get_skips_and_dels",value:function(){return this._get_mismatches()}}]),e}(),y=function(e){Object(o.a)(r,e);var t=Object(u.a)(r);function r(){var e;Object(s.a)(this,r);for(var a=arguments.length,n=new Array(a),i=0;i<a;i++)n[i]=arguments[i];return(e=t.call.apply(t,[this].concat(n))).cram=void 0,e.setupP=void 0,e.sequenceAdapter=void 0,e.samHeader={},e.seqIdToRefName=void 0,e.seqIdToOriginalRefName=[],e}return Object(c.a)(r,[{key:"configure",value:function(){var e=Object(i.a)(n.a.mark((function e(){var t,r,a,i,s;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=Object(g.readConfObject)(this.config,"cramLocation"),r=Object(g.readConfObject)(this.config,"craiLocation"),t){e.next=4;break}throw new Error("missing cramLocation argument");case 4:if(r){e.next=6;break}throw new Error("missing craiLocation argument");case 6:if(this.cram=new d.IndexedCramFile({cramFilehandle:Object(l.openLocation)(t),index:new d.CraiIndex({filehandle:Object(l.openLocation)(r)}),seqFetch:this.seqFetch.bind(this),checkSequenceMD5:!1,fetchSizeLimit:this.config.fetchSizeLimit||6e8}),a=Object(g.readConfObject)(this.config,["sequenceAdapter","type"]),this.getSubAdapter){e.next=10;break}throw new Error("Error getting subadapter");case 10:return e.next=12,this.getSubAdapter(Object(g.readConfObject)(this.config,"sequenceAdapter"));case 12:if(i=e.sent,!((s=i.dataAdapter)instanceof f.BaseFeatureDataAdapter)){e.next=18;break}this.sequenceAdapter=s,e.next=19;break;case 18:throw new Error("CRAM feature adapters cannot use sequence adapters of type '".concat(a,"'"));case 19:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"getHeader",value:function(){var e=Object(i.a)(n.a.mark((function e(t){return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.configure();case 2:return e.abrupt("return",this.cram.cram.getHeaderText(t));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"seqFetch",value:function(){var e=Object(i.a)(n.a.mark((function e(t,r,a){var i,s,c,o,u,d;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r-=1,i=this.sequenceAdapter){e.next=4;break}return e.abrupt("return",void 0);case 4:if(s=this.refIdToOriginalName(t)||this.refIdToName(t)){e.next=7;break}return e.abrupt("return",void 0);case 7:return c=i.getFeatures({refName:s,start:r,end:a,assemblyName:""},{}),e.next=10,c.pipe(Object(m.a)()).toPromise();case 10:if(o=e.sent,u=[],o.sort((function(e,t){return e.get("start")-t.get("start")})).forEach((function(e){var t=e.get("start"),n=e.get("end"),i=Math.max(r-t,0),s=Math.min(a-t,n-t)-i,c=e.get("seq")||e.get("residues");u.push(c.substr(i,s))})),(d=u.join("")).length===a-r){e.next=16;break}throw new Error("sequence fetch failed: fetching ".concat(s,":").concat((r-1).toLocaleString(),"-").concat(a.toLocaleString()," returned ").concat(d.length.toLocaleString()," bases, but should have returned ").concat((a-r).toLocaleString()));case 16:return e.abrupt("return",d);case 17:case"end":return e.stop()}}),e,this)})));return function(t,r,a){return e.apply(this,arguments)}}()},{key:"setup",value:function(){var e=Object(i.a)(n.a.mark((function e(t){var r,a,s=this;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=(t||{}).statusCallback,a=void 0===r?function(){}:r,this.setupP||(this.setupP=this.configure().then(Object(i.a)(n.a.mark((function e(){var r,i,c,o;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a("Downloading index"),e.next=3,s.cram.cram.getSamHeader(null===t||void 0===t?void 0:t.signal);case 3:return r=e.sent,i=[],c={},r.filter((function(e){return"SQ"===e.tag})).forEach((function(e,t){e.data.forEach((function(e){if("SN"===e.tag){var r=e.value;c[r]=t,i[t]=r}}))})),o=r.filter((function(e){return"RG"===e.tag})).map((function(e){var t;return null===(t=e.data.find((function(e){return"ID"===e.tag})))||void 0===t?void 0:t.value})),i.length&&(s.samHeader={idToName:i,nameToId:c,readGroups:o}),a(""),e.abrupt("return",s.samHeader);case 11:case"end":return e.stop()}}),e)})))).catch((function(e){throw s.setupP=void 0,e}))),e.abrupt("return",this.setupP);case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getRefNames",value:function(){var e=Object(i.a)(n.a.mark((function e(t){return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.setup(t);case 2:if(!this.samHeader.idToName){e.next=4;break}return e.abrupt("return",this.samHeader.idToName);case 4:if(!this.sequenceAdapter){e.next=6;break}return e.abrupt("return",this.sequenceAdapter.getRefNames());case 6:throw new Error("unable to get refnames");case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"refNameToId",value:function(e){return this.samHeader.nameToId?this.samHeader.nameToId[e]:this.seqIdToRefName?this.seqIdToRefName.indexOf(e):void 0}},{key:"refIdToName",value:function(e){return this.samHeader.idToName?this.samHeader.idToName[e]:this.seqIdToRefName?this.seqIdToRefName[e]:void 0}},{key:"refIdToOriginalName",value:function(e){return this.seqIdToOriginalRefName[e]}},{key:"getFeatures",value:function(e,t){var r=this,a=t||{},s=a.signal,c=a.statusCallback,o=void 0===c?function(){}:c,u=e.refName,d=e.start,f=e.end,l=e.originalRefName;return Object(p.ObservableCreate)(function(){var e=Object(i.a)(n.a.mark((function e(a){var i,c;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.setup(t);case 2:if(!r.sequenceAdapter||r.seqIdToRefName){e.next=6;break}return e.next=5,r.sequenceAdapter.getRefNames(t);case 5:r.seqIdToRefName=e.sent;case 6:if(void 0===(i=r.refNameToId(u))){e.next=15;break}return l&&(r.seqIdToOriginalRefName[i]=l),o("Downloading alignments"),e.next=12,r.cram.getRecordsForRange(i,d,f,t);case 12:c=e.sent,Object(h.checkAbortSignal)(s),c.forEach((function(e){a.next(r.cramRecordToFeature(e))}));case 15:o(""),a.complete();case 17:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),s)}},{key:"freeResources",value:function(){}},{key:"cramRecordToFeature",value:function(e){return new b(e,this)}}]),r}(f.BaseFeatureDataAdapter)}}]);
//# sourceMappingURL=50.e3c3b652.chunk.js.map